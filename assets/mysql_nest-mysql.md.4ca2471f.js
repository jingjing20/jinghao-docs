import{_ as s,o as n,c as a,V as l}from"./chunks/framework.92369faf.js";const p="/jinghao-docs/assets/image.a3435cec.png",o="/jinghao-docs/assets/image-1.7479b7f6.png",e="/jinghao-docs/assets/image-2.1b5df5a6.png",r="/jinghao-docs/assets/image-3.8ebef884.png",c="/jinghao-docs/assets/image-4.03579273.png",t="/jinghao-docs/assets/mysql-transaction.76f21cbd.gif",h=JSON.parse('{"title":"nest 小册 mysql 练习","description":"","frontmatter":{},"headers":[],"relativePath":"mysql/nest-mysql.md","filePath":"mysql/nest-mysql.md","lastUpdated":1692978539000}'),C={name:"mysql/nest-mysql.md"},y=l('<h1 id="nest-小册-mysql-练习" tabindex="-1">nest 小册 mysql 练习 <a class="header-anchor" href="#nest-小册-mysql-练习" aria-label="Permalink to &quot;nest 小册 mysql 练习&quot;">​</a></h1><h2 id="常用查询" tabindex="-1">常用查询 <a class="header-anchor" href="#常用查询" aria-label="Permalink to &quot;常用查询&quot;">​</a></h2><h3 id="准备练习数据表" tabindex="-1">准备练习数据表 <a class="header-anchor" href="#准备练习数据表" aria-label="Permalink to &quot;准备练习数据表&quot;">​</a></h3><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 创建 customers 表，用于存储客户信息</span></span>\n<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">customers</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> (</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">客户ID，自增长</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">255</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">客户姓名，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">)</span></span>\n<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">客户信息表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#676E95;font-style:italic;">-- 创建 orders 表，用于存储订单信息</span></span>\n<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">orders</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> (</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单ID，自增长</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">customer_id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">客户ID，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">order_date</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">date</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单日期，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">total_amount</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">decimal</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单总金额，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FOREIGN KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">customer_id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">REFERENCES</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">customers</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">ON DELETE CASCADE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> CASCADE</span></span>\n<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单信息表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#676E95;font-style:italic;">-- 创建 order_items 表，用于存储订单商品信息</span></span>\n<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">order_items</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> (</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品ID，自增长</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">order_id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单ID，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">product_name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">255</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品名称，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">quantity</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品数量，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">price</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">decimal</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品单价，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FOREIGN KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">order_id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">REFERENCES</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">orders</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">ON DELETE CASCADE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> CASCADE</span></span>\n<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单商品信息表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="往表里插入练习数据" tabindex="-1">往表里插入练习数据 <a class="header-anchor" href="#往表里插入练习数据" aria-label="Permalink to &quot;往表里插入练习数据&quot;">​</a></h3><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 向 customers 表插入数据</span></span>\n<span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">customers</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">)</span></span>\n<span class="line"><span style="color:#A6ACCD;">  	</span><span style="color:#F78C6C;">VALUES</span></span>\n<span class="line"><span style="color:#A6ACCD;">		(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张丽娜</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">李明</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">王磊</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">赵静</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">钱伟</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">		(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">孙芳</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">周涛</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">吴洋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">郑红</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">刘华</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">		(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">陈明</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">杨丽</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">王磊</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张伟</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">李娜</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">		(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">刘洋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">陈静</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">杨阳</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">王丽</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张强</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#676E95;font-style:italic;">-- 向 orders 表插入数据</span></span>\n<span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">orders</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">customer_id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">order_date</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">total_amount</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">)</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">VALUES</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">300</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),(</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-04</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">400</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-05</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">500</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),(</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-06</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">600</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-07</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">700</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),(</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-08</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">800</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-09</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">900</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-10</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">1000</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#676E95;font-style:italic;">-- 向 order_items 表插入数据</span></span>\n<span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">order_items</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">order_id</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">product_name</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">quantity</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">price</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;">)</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">VALUES</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">耐克篮球鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">阿迪达斯跑步鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">匡威帆布鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">万斯板鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">新百伦运动鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">彪马休闲鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">6</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">锐步经典鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">7</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">亚瑟士运动鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">帆布鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">苹果手写笔</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">电脑包</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">苹果手机</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">苹果耳机</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>\n<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">苹果平板</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">7</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="练习-1-查询每个客户的订单总金额" tabindex="-1">练习 1: 查询每个客户的订单总金额 <a class="header-anchor" href="#练习-1-查询每个客户的订单总金额" aria-label="Permalink to &quot;练习 1: 查询每个客户的订单总金额&quot;">​</a></h3><div class="info custom-block"><p class="custom-block-title">思路</p><p>客户的订单存在订单表里，每个客户的订单可以有多个，所以这里需要用 <code>JOIN ON</code> 关联两个表，然后用 <code>GROUP BY</code> 根据客户 <code>id</code> 分组，再通过 <code>SUM</code> 函数计算价格总和。</p></div><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount</span></span>\n<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>\n<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> customers.id</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>执行下查询语句，可以看到每个客户的订单总金额</li></ul><p><img src="'+p+`" alt="Alt text"></p><h4 id="可以加个排序" tabindex="-1">可以加个排序 <a class="header-anchor" href="#可以加个排序" aria-label="Permalink to &quot;可以加个排序&quot;">​</a></h4><ul><li>排序的时候，可以用 <code>ASC</code> 或者 <code>DESC</code> 来指定升序或降序，如果不指定，默认是升序。</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> customers.id</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> total_amount </span><span style="color:#F78C6C;">DESC</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="`+o+`" alt="Alt text"></p><h4 id="也可以加个查询数量限制" tabindex="-1">也可以加个查询数量限制 <a class="header-anchor" href="#也可以加个查询数量限制" aria-label="Permalink to &quot;也可以加个查询数量限制&quot;">​</a></h4><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> customers.id</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> total_amount </span><span style="color:#F78C6C;">DESC</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="`+e+`" alt="Alt text"></p><h3 id="练习-2-查询每个客户的订单总金额-并计算其占比" tabindex="-1">练习 2: 查询每个客户的订单总金额，并计算其占比 <a class="header-anchor" href="#练习-2-查询每个客户的订单总金额-并计算其占比" aria-label="Permalink to &quot;练习 2: 查询每个客户的订单总金额，并计算其占比&quot;">​</a></h3><ul><li>每个客户的总金额的需求上面实现了，这里只需要算占比</li><li>可以通过一个子查询来计算全部订单的总金额，然后再相除就可以了</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount,</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(total_amount) </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> orders) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">percentage</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">INNER JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> customers.id;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="`+r+`" alt="Alt text"></p><h4 id="查询优化" tabindex="-1">查询优化 <a class="header-anchor" href="#查询优化" aria-label="Permalink to &quot;查询优化&quot;">​</a></h4><ul><li>这里每次都算一遍总金额性能不好，可以先算出总金额，然后把数值传入。</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 计算总订单金额</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_order_amount </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">INTO</span><span style="color:#A6ACCD;"> @total_amount;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 使用计算得到的总订单金额进行查询</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name,</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount,</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> @total_amount </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">percentage</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#F78C6C;">INNER JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> customers.id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 清除变量</span></span>
<span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> @total_amount </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NULL</span><span style="color:#A6ACCD;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="练习-3-查询每个客户的订单总金额-并列出每个订单的商品清单" tabindex="-1">练习 3：查询每个客户的订单总金额，并列出每个订单的商品清单 <a class="header-anchor" href="#练习-3-查询每个客户的订单总金额-并列出每个订单的商品清单" aria-label="Permalink to &quot;练习 3：查询每个客户的订单总金额，并列出每个订单的商品清单&quot;">​</a></h3><ul><li>这里在总金额的基础上，多了订单项的查询，需要多关联一个表：<code>order_items</code></li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, orders.order_date, orders.total_amount,</span></span>
<span class="line"><span style="color:#A6ACCD;">	order_items.product_name, order_items.quantity, order_items.price</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> order_items </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> orders.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> order_items.order_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> customers.name, orders.order_date;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>内连接 3 个表，同时按照名字和下单日期排序。</li><li>多个字段排序的时候，可以用 <code>,</code> 分隔，也可以用 <code>AND</code> 连接。</li><li>这里用的是 <code>,</code> 分隔，先按照名字排序，如果名字相同，再按照下单日期排序。</li></ul><p><img src="`+c+`" alt="Alt text"></p><h4 id="可以过滤某个客户的订单" tabindex="-1">可以过滤某个客户的订单 <a class="header-anchor" href="#可以过滤某个客户的订单" aria-label="Permalink to &quot;可以过滤某个客户的订单&quot;">​</a></h4><ul><li>比如只查询 <code>张丽娜</code> 的订单</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, orders.order_date, orders.total_amount,</span></span>
<span class="line"><span style="color:#A6ACCD;">	order_items.product_name, order_items.quantity, order_items.price</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> order_items </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> orders.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> order_items.order_id</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> customers.name </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张丽娜</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> customers.name, orders.order_date;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="可以过滤某个时间段的订单" tabindex="-1">可以过滤某个时间段的订单 <a class="header-anchor" href="#可以过滤某个时间段的订单" aria-label="Permalink to &quot;可以过滤某个时间段的订单&quot;">​</a></h4><ul><li>比如查询 2022 年 1 月 1 日到 2022 年 1 月 3 日的订单</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, orders.order_date, orders.total_amount,</span></span>
<span class="line"><span style="color:#A6ACCD;">	order_items.product_name, order_items.quantity, order_items.price</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> order_items </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> orders.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> order_items.order_id</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> orders.order_date </span><span style="color:#F78C6C;">BETWEEN</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AND</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-03</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> customers.name, orders.order_date;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>因为这里的 <code>order_date</code> 是 <code>date</code> 类型，所以指定范围也只是用 <code>2022-01-01</code> 这种格式的。如果是 <code>datetime</code>，那就要用 <code>2022-01-01 10:10:00</code> 这种格式了。</li><li><code>WHERE</code> 过滤的时候，可以用 <code>AND</code> 或者 <code>OR</code> 来连接多个条件，也可以用 <code>IN</code> 来过滤多个值。</li><li>还可以模糊匹配等等，这里不再赘述。详见上一篇文章：<a href="./mysql-bizhibihui.html">mysql 必知必会阅读笔记</a></li></ul><h3 id="练习-4-查询每个客户的订单总金额-并计算商品数量-只包含商品名称包含-鞋-的商品-商品名用-连接" tabindex="-1">练习 4：查询每个客户的订单总金额，并计算商品数量，只包含商品名称包含“鞋”的商品，商品名用-连接： <a class="header-anchor" href="#练习-4-查询每个客户的订单总金额-并计算商品数量-只包含商品名称包含-鞋-的商品-商品名用-连接" aria-label="Permalink to &quot;练习 4：查询每个客户的订单总金额，并计算商品数量，只包含商品名称包含“鞋”的商品，商品名用-连接：&quot;">​</a></h3><ul><li>查询订单总金额和商品数量都需要用 group by 根据 customer.id 分组</li><li>过滤出只包含鞋的商品</li><li>把分组的多条商品名连接起来需要用 GROUP_CONCAT 函数。</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span></span>
<span class="line"><span style="color:#A6ACCD;">	c.name </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> customer_name,</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(o.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount,</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">COUNT</span><span style="color:#A6ACCD;">(oi.id) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_quantity,</span></span>
<span class="line"><span style="color:#A6ACCD;">	GROUP_CONCAT(oi.product_name SEPARATOR </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">-</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> product_names</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers c</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> orders o </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> c.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> o.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> order_items oi </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> o.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> oi.order_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> oi.product_name </span><span style="color:#F78C6C;">LIKE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%鞋%</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> c.name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> total_amount </span><span style="color:#F78C6C;">DESC</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>GROUP_CONCAT 函数是用于 group by 分组后，把多个值连接成一个字符串的。</li></ul><h3 id="练习-5-将张丽娜的订单总金额打九折" tabindex="-1">练习 5：将张丽娜的订单总金额打九折 <a class="header-anchor" href="#练习-5-将张丽娜的订单总金额打九折" aria-label="Permalink to &quot;练习 5：将张丽娜的订单总金额打九折&quot;">​</a></h3><ul><li>这里用户名为王磊的用户不止一条，所以用 <code>IN</code> 来指定一个集合。</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> orders o </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> o.total_amount </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> o.total_amount </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">9</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> o.customer_id </span><span style="color:#F78C6C;">IN</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> id </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张丽娜</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    );</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="mysql-中的事务" tabindex="-1">mysql 中的事务 <a class="header-anchor" href="#mysql-中的事务" aria-label="Permalink to &quot;mysql 中的事务&quot;">​</a></h2><div class="info custom-block"><p class="custom-block-title">事务的概念</p><p>当涉及到数据库操作时，事务是一个非常重要的概念，它确保了数据的一致性和完整性。在 <code>MySQL</code> 数据库中，事务是一组数据库操作，被视为一个单独的工作单元。事务内的操作要么全部成功执行，要么全部不执行。如果事务在执行过程中发生错误，所有已经执行的操作都将被撤销，数据库状态回到事务开始前的状态。</p></div><h3 id="什么是事务" tabindex="-1">什么是事务？ <a class="header-anchor" href="#什么是事务" aria-label="Permalink to &quot;什么是事务？&quot;">​</a></h3><p>事务是一组数据库操作，要么全部成功地执行，要么全部不执行。事务具有以下四个关键属性，通常被称为 <code>ACID</code> 属性：</p><ul><li><p><strong>原子性 <code>Atomicity</code></strong>：事务被视为一个原子操作，要么全部执行，要么全部回滚。如果事务在执行过程中发生错误，所有已经执行的操作都将被撤销，数据库状态回到事务开始前的状态。</p></li><li><p><strong>一致性 <code>Consistency</code></strong>：事务将数据库从一个一致状态转移到另一个一致状态。这意味着事务在执行前后，数据库中的约束和规则都得到了保持。</p></li><li><p><strong>隔离性 <code>Isolation</code></strong>：并发事务的执行是相互隔离的，即一个事务的执行不应该受到其他事务的影响。数据库系统必须确保事务在执行期间不会互相干扰。</p></li><li><p><strong>持久性 <code>Durability</code></strong>：一旦事务被提交，其结果将永久保存在数据库中，即使发生系统故障也不会丢失。</p></li></ul><h4 id="事务隔离级别" tabindex="-1">事务隔离级别 <a class="header-anchor" href="#事务隔离级别" aria-label="Permalink to &quot;事务隔离级别&quot;">​</a></h4><p><code>MySQL</code> 支持不同的事务隔离级别，用于控制并发事务之间的可见性和影响。常见的事务隔离级别包括：</p><ul><li><p><strong>读未提交 <code>Read Uncommitted</code></strong>：允许一个事务读取另一个事务未提交的数据。最低的隔离级别，可能导致脏读、不可重复读和幻读问题。</p></li><li><p><strong>读已提交 <code>Read Committed</code></strong>：一个事务只能读取其他已提交事务的数据。解决了脏读问题，但仍可能出现不可重复读和幻读问题。</p></li><li><p><strong>可重复读 <code>Repeatable Read</code></strong>：保证在同一事务中多次读取相同数据时，得到的结果是一致的。解决了不可重复读问题，但仍可能出现幻读问题。</p></li><li><p><strong>串行化 <code>Serializable</code></strong>：最高的隔离级别，确保每个事务都像顺序执行一样。解决了幻读问题，但会导致并发性能下降。</p></li></ul><h4 id="事务的使用方法" tabindex="-1">事务的使用方法 <a class="header-anchor" href="#事务的使用方法" aria-label="Permalink to &quot;事务的使用方法&quot;">​</a></h4><p>在 <code>MySQL</code> 中，可以使用以下语句来管理事务：</p><ul><li><p><strong>开始事务</strong>：使用 <code>START TRANSACTION</code> 或 <code>BEGIN</code> 语句开始一个新的事务。</p></li><li><p><strong>提交事务</strong>：使用 <code>COMMIT</code> 语句将已执行的事务更改永久保存到数据库。</p></li><li><p><strong>回滚事务</strong>：使用 <code>ROLLBACK</code> 语句撤消事务中的所有更改，回到事务开始前的状态。</p></li><li><p><strong>设置保存点</strong>：使用 <code>SAVEPOINT</code> 命令在事务中创建一个保存点，可以在需要时回滚到该点。</p></li></ul><h4 id="事务管理和优化" tabindex="-1">事务管理和优化 <a class="header-anchor" href="#事务管理和优化" aria-label="Permalink to &quot;事务管理和优化&quot;">​</a></h4><p>以下是一些关于事务管理和优化的提示：</p><ul><li><p><strong>尽量缩短事务持续时间</strong>：长时间的事务可能导致锁定资源，影响并发性能。</p></li><li><p><strong>选择适当的隔离级别</strong>：根据应用需求选择合适的隔离级别，权衡并发性能和数据的一致性。</p></li><li><p><strong>使用事务批处理</strong>：将多个操作合并到一个事务中，减少事务的开销，提高性能。</p></li><li><p><strong>避免长时间的只读事务</strong>：长时间的只读事务可能阻塞其他事务的写操作。</p></li><li><p><strong>使用索引</strong>：为经常涉及到的字段创建索引，减少锁的竞争。</p></li><li><p><strong>定期清理过期数据</strong>：删除不再需要的数据，减少事务的冲突。</p></li></ul><h3 id="实操一下" tabindex="-1">实操一下 <a class="header-anchor" href="#实操一下" aria-label="Permalink to &quot;实操一下&quot;">​</a></h3><p>还是基于上文中的数据库和数据表的数据来测试一下事务相关的问题</p><h4 id="回滚所有-sql" tabindex="-1">回滚所有 sql <a class="header-anchor" href="#回滚所有-sql" aria-label="Permalink to &quot;回滚所有 sql&quot;">​</a></h4><ul><li>首先开启一个事务</li><li>然后执行两条 <code>DML</code> 语句，分别更新 <code>order_items</code> 表和 <code>orders</code> 表的数据</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 开启事务</span></span>
<span class="line"><span style="color:#F78C6C;">START TRANSACTION</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 更新 order_items 表的数据</span></span>
<span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> order_items </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> quantity </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> order_id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 更新 orders 表的数据</span></span>
<span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> total_amount </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>执行 <code>DML</code> 语句之后分别查询一下这两个表的数据，能从结果中看到数据已经被改变了</li><li>其实现在真实数据库的数据还是没有改变的，因为这个事务还没提交</li><li>我们也可以执行一下 <code>ROLLBACK</code> 撤销此次事务</li><li>撤销之后可以再执行一下查询，会发现查出来的数据又回到了执行 <code>DML</code> 语句之前的原始数据</li></ul><p><img src="`+t+`" alt="mysql-transaction"></p><ul><li>如果确定需要修改，也可以执行一下 <code>COMMIT</code> 语句，执行完 <code>COMMIT</code> 语句后数据就真正被修改，不能再回滚了。</li></ul><h4 id="回滚部分-sql" tabindex="-1">回滚部分 sql <a class="header-anchor" href="#回滚部分-sql" aria-label="Permalink to &quot;回滚部分 sql&quot;">​</a></h4><ul><li>上面的操作会把当前执行的 <code>sql</code> 全部回滚，我们有时候希望回滚到某一个阶段怎么操作呢？</li><li>上面的理论知识中提到了，要实现这样的效果，可以借助 <code>SAVEPOINT</code> 命令</li><li><code>SAVEPOINT</code> 命令在事务中创建一个保存点，可以在需要时回滚到该点。</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">START TRANSACTION</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">SAVEPOINT aaa;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> order_items </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> quantity </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> order_id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">SAVEPOINT bbb;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> total_amount </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">SAVEPOINT ccc;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> total_amount </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">900</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6</span><span style="color:#A6ACCD;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>上面的 sql 中设置了三个保存点，分别是 <code>aaa</code>、<code>bbb</code>、<code>ccc</code>，每个保存点都是在执行 <code>DML</code> 语句之前设置的，所以每个保存点都是在执行 <code>DML</code> 语句之前的状态。</li><li>我们想回滚到某个保存点只要执行 <code>ROLLBACK TO SAVEPOINT xxx;</code></li></ul><div class="info custom-block"><p class="custom-block-title">@@autocommit</p><p>在 MySQL 数据库中，<code>@@autocommit</code> 是一个系统变量，用于控制事务的自动提交行为。事务是一组数据库操作，要么全部成功地执行，要么全部回滚，以保证数据的一致性和完整性。<code>@@autocommit</code> 变量决定了每个 SQL 语句是否被视为一个单独的事务，并在执行完成后自动提交，还是需要手动执行 <code>COMMIT</code> 或 <code>ROLLBACK</code> 语句来结束事务。</p><p>默认情况下，<code>@@autocommit</code> 的值为 1，表示自动提交模式开启，即每个 SQL 语句都被视为一个单独的事务，并在执行完成后自动提交。你可以通过修改 <code>@@autocommit</code> 的值来切换自动提交模式和手动提交模式。</p><p>下面是一些关于 <code>@@autocommit</code> 的使用方法和示例：</p><ul><li>查看当前 @@autocommit 的值：</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> @@autocommit;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ul><li>关闭自动提交模式（手动提交模式）：</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> @@autocommit </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>在手动提交模式下，你需要在执行一系列的 SQL 语句后使用 <code>COMMIT</code> 语句来提交事务，或使用 <code>ROLLBACK</code> 语句来回滚事务。</p><ul><li>打开自动提交模式（自动提交模式）：</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> @@autocommit </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>在自动提交模式下，每个 SQL 语句将被视为一个独立的事务，执行后立即提交。</p><ul><li>在手动提交模式下执行事务：</li></ul><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> @@autocommit </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 一系列 SQL 语句</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">COMMIT</span><span style="color:#A6ACCD;">; </span><span style="color:#676E95;font-style:italic;">-- 手动提交事务</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>使用手动提交模式时，你可以在一系列 SQL 语句执行完成后显式地使用 <code>COMMIT</code> 来提交事务。</p><p>总之，<code>@@autocommit</code> 是一个重要的系统变量，它控制了事务的自动提交行为。通过适当地设置它，你可以选择是让每个 SQL 语句自动提交，还是将它们组合成更大的事务，以便在完成一系列操作后进行手动提交。</p></div><ul><li>我在本地测试过了，和上面说的不一样，暂时不知道原因</li></ul>`,72),A=[y];function D(i,F,d,m,u,b){return n(),a("div",null,A)}const _=s(C,[["render",D]]);export{h as __pageData,_ as default};
