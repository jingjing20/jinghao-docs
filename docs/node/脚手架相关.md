# è„šæ‰‹æ¶ç›¸å…³

## æ¨¡å¼ä¸€ï¼šä½¿ç”¨å¹³å°æä¾› api è¿œç«¯è¯»å–è´¦æˆ·ä¸‹æ‰€æœ‰ä»“åº“ä¾›ç”¨æˆ·é€‰æ‹©æ¨¡æ¿

ä¸»è¦ä»£ç å¦‚å›¾ï¼š

![cli-code](cli-code.png)

### æ ¸å¿ƒä»£ç 

#### cli.js

```js
#! /usr/bin/env node
const { program } = require('commander');
const inquirer = require('inquirer');
const package = require('../package.json');
const fs = require('fs-extra'); // å¼•å…¥fs-extra
const path = require('path');
const logger = require('./logger');
const ora = require('ora');
const { execSync } = require('child_process');
const { getGitReposList } = require('./api.js'); // æ–°å¢
const downloadGitRepo = require('download-git-repo');

// å®šä¹‰å½“å‰ç‰ˆæœ¬
program.version(package.version);

program
  .command('create [projectName]') // [projectName]æ˜¯å¯é€‰ <projectName>æ˜¯å¿…å¡«
  .description('æ–°å»ºæ¨¡æ¿é¡¹ç›®')
  .option('-t, --template <template>', 'æ¨¡æ¿é¡¹ç›®åç§°')
  .action(async (projectName, options) => {
    // æ·»åŠ è·å–æ¨¡ç‰ˆåˆ—è¡¨æ¥å£å’Œloading
    const getRepoLoading = ora('è·å–æ¨¡æ¿é¡¹ç›®åˆ—è¡¨...');
    getRepoLoading.start();
    const templates = await getGitReposList('jingjing20');
    getRepoLoading.succeed('è·å–æ¨¡ç‰ˆé¡¹ç›®åˆ—è¡¨æˆåŠŸ!');
    // 1ã€ ä»æ¨¡ç‰ˆåˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„æ¨¡ç‰ˆ
    let project = templates.find((template) => template.name === options.template);
    // 2ã€ å¦‚æœåŒ¹é…åˆ°æ¨¡ç‰ˆå°±èµ‹å€¼ï¼Œæ²¡æœ‰åŒ¹é…åˆ°å°±æ˜¯undefined
    let projectTemplate = project ? project.value : undefined;

    // 3ã€ å¦‚æœç”¨æˆ·æ²¡æœ‰ä¼ å…¥åç§°å°±äº¤äº’å¼è¾“å…¥
    if (!projectName) {
      const { name } = await inquirer.prompt({
        type: 'input',
        name: 'name',
        message: 'è¯·è¾“å…¥é¡¹ç›®åç§°ï¼š'
      });
      projectName = name; // èµ‹å€¼è¾“å…¥çš„é¡¹ç›®åç§°
    }
    // 4ã€ å¦‚æœç”¨æˆ·æ²¡æœ‰ä¼ å…¥æ¨¡ç‰ˆå°±äº¤äº’å¼è¾“å…¥
    if (!projectTemplate) {
      const { template } = await inquirer.prompt({
        type: 'list',
        name: 'template',
        message: 'è¯·é€‰æ‹©æ¨¡ç‰ˆé¡¹ç›®ï¼š',
        choices: templates // æ¨¡ç‰ˆåˆ—è¡¨
      });
      projectTemplate = template; // èµ‹å€¼é€‰æ‹©çš„é¡¹ç›®åç§°
    }
    // è·å–ç›®æ ‡æ–‡ä»¶å¤¹
    const dest = path.join(process.cwd(), projectName);

    // åˆ¤æ–­æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨å°±äº¤äº’è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦†ç›–
    if (fs.existsSync(dest)) {
      const { force } = await inquirer.prompt({
        type: 'confirm',
        name: 'force',
        message: 'ç›®å½•å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ'
      });
      // å¦‚æœè¦†ç›–å°±åˆ é™¤æ–‡ä»¶å¤¹ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¦çš„è¯å°±é€€å‡ºè¿›ç¨‹
      force ? fs.removeSync(dest) : process.exit(1);
    }
    // å®šä¹‰loading
    const loading = ora('æ­£åœ¨ä¸‹è½½æ¨¡ç‰ˆé¡¹ç›®...');
    // å¼€å§‹loading
    loading.start();
    // 5ã€å¼€å§‹ä¸‹è½½æ¨¡ç‰ˆ
    downloadGitRepo(projectTemplate, dest, (err) => {
      if (err) {
        loading.fail('åˆ›å»ºæ¨¡ç‰ˆé¡¹ç›®å¤±è´¥', err);
      } else {
        loading.succeed();
        console.log();
        logger.mixin(`ğŸš€  Successfully created project`, projectName);
        logger.info('ğŸ‘‰  Get started with the following commands:');
        console.log();
        logger.info(`$ cd ${projectName}`);
        logger.info('$ pnpm i');
        logger.info('$ pnpm dev');
      }
    });
  });

program.on('--help', () => {}); // æ·»åŠ --help

// å®šä¹‰ä½¿ç”¨æ–¹æ³•
program.parse();
```

#### api.js

```js
// bin/api.js
const https = require('https');
const logger = require('./logger');

/** è·å–ç”¨æˆ·gitä»“åº“åˆ—è¡¨ä¿¡æ¯ */
function getGitReposList(username) {
  return new Promise((resolve, reject) => {
    https
      .request(
        `https://api.github.com/users/${username}/repos`,
        {
          headers: {
            'User-Agent': username
          }
        },
        (res) => {
          let data = '';
          res.on('data', (chunk) => {
            data += chunk.toString();
          });
          res.on('end', () => {
            const list = JSON.parse(data);
            resolve(
              list.map((item) => ({
                // ç»„åˆæˆæ¨¡ç‰ˆæ‰€éœ€è¦çš„nameï¼Œvalueç»“æ„
                name: item.name,
                value: `https://github.com:${username}/${item.name}`
              }))
            );
          });
          res.on('error', (err) => {
            reject(err);
          });
        }
      )
      .end();
  }).catch((err) => {
    logger.error(err);
  });
}

module.exports = {
  getGitReposList
};
```

#### æ‰€æœ‰ä»£ç è§ä»“åº“

- [wang-cli](https://github.com/jingjing20/wang-cli)

## æ¨¡å¼äºŒï¼šæ¨¡æ¿ä»£ç æ²¡æ”¾å•ç‹¬ä»“åº“ï¼Œè€Œæ˜¯åœ¨æŸä¸ªä»“åº“ä¸‹é¢çš„æ–‡ä»¶å¤¹é‡Œ

- å…ˆæ–°å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•ç”¨äºå­˜æ”¾ç›®æ ‡ä»“åº“ï¼Œè¿™æ ·ä¸ä¼šæ±¡æŸ“ç”¨æˆ·çš„æ–‡ä»¶å¤¹ã€‚
- ç„¶åæŠŠè¿œç«¯ä»“åº“ä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•é‡Œé¢ã€‚
- å†è¿›ä¸€æ­¥æ“ä½œæ–‡ä»¶å¤¹çš„ copy å°±è¡Œäº†ã€‚
- æœ€åè¦æŠŠç”Ÿæˆçš„ä¸´æ—¶ç›®å½•åˆ é™¤ã€‚

```ts
import path from 'path';
import logger from '../shared/logger.js';
import inquirer from 'inquirer';
import fse from 'fs-extra';
// ä¼˜åŒ–ä¸‹è½½è¿‡ç¨‹
import ora from 'ora';
import { exec } from 'child_process';
import chalk from 'chalk';

interface CreateCommandOptions {
  name?: string;
}

const sourceDirectory = path.join(process.cwd(), `/wangzhihao-cli-temp-${new Date().getTime().toString()}/`); // ä¸´æ—¶å­˜æ”¾ç›®å½•
const relativePath = '@@@@@@@@@@';

export async function createTemplate(options: CreateCommandOptions) {
  logger.title('\nğŸ“¦ Create a template project! \n');
  let projectName: string;
  if (options.name) {
    projectName = options.name;
  } else {
    const { name } = await inquirer.prompt({
      type: 'input',
      name: 'name',
      message: 'è¯·è¾“å…¥é¡¹ç›®åç§°ï¼š'
    });
    projectName = name; // èµ‹å€¼è¾“å…¥çš„é¡¹ç›®åç§°
  }

  // åˆ›å»ºä¸´æ—¶ç›®å½•
  await fse.mkdir(sourceDirectory, { recursive: true });
  // ç›®æ ‡ç›®å½•è·¯å¾„
  const targetDirectory = process.cwd() + '/' + projectName;

  // å®šä¹‰loading
  const spinner = ora({
    text: 'æ­£åœ¨æ‹‰å–è¿œç«¯æ¨¡ç‰ˆé¡¹ç›®...',
    spinner: 'arrow3'
  }).start();

  await new Promise<void>((resolve) => {
    exec(
      'git clone -b feature/### git åœ°å€',
      {
        cwd: sourceDirectory // path to where you want to save the file
      },
      (error: any, stdout: string, stderr: string) => {
        if (error) {
          // åˆ é™¤ä¸´æ—¶ç›®å½•
          fse.remove(sourceDirectory);
          logger.info(stderr);
          spinner.fail(
            chalk.hex('#ff9800')(
              'å¾ˆæŠ±æ­‰ï¼Œæ‚¨å¯èƒ½ç›®å‰æ²¡æœ‰è®¿é—® Git ä»“åº“çš„æƒé™ã€‚è¯·å‘ä»“åº“ç®¡ç†å‘˜ç”³è¯·è®¿é—®æƒé™ã€‚'
            )
          );
          logger.greyinfo('ä»“åº“åœ°å€ï¼š');
        } else {
          resolve();
        }
      }
    );
  }).then(async () => {
    try {
      // ä»æ¨¡æ¿é¡¹ç›®æ‹·è´æ‰€æœ‰æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•ä¸‹
      await fse.copySync(sourceDirectory + relativePath, targetDirectory);
      spinner.succeed('æ‹‰å–æ¨¡æ¿æˆåŠŸ');
      console.log();
      logger.mixin(`ğŸš€  Successfully created project`, projectName);
      logger.greyinfo('ğŸ‘‰  Get started with the following commands:');
      console.log();
      logger.greyinfo(`$ cd ${projectName}`);
      logger.greyinfo('$ pnpm i');
      logger.greyinfo('$ pnpm dev');
    } catch (error: any) {
      logger.error(error);
    }
  });

  // åˆ é™¤ä¸´æ—¶ç›®å½•
  fse.remove(sourceDirectory);
}
```
